#!/bin/bash
app=gogs

# Retrieve settings
domain=$(sudo yunohost app setting $app domain)
path=$(sudo yunohost app setting $app path)
repo_path=$(sudo yunohost app setting $app repopath)
db_pwd=$(sudo yunohost app setting $app mysqlpwd)
key=$(sudo yunohost app setting $app secret_key)
architecture=$(sudo yunohost app setting $app architecture)

# cut the second "/"
path="/$(echo "$path" | cut -d/ -f2)"


if [[ $architecture = "other" ]]
then
    # Build Gogs
    base_directory=$PWD
    export GOPATH=/opt/gogs_build
    cd /opt/gogs_build
    sudo GOPATH=/opt/gogs_build: go get -u github.com/gogits/gogs
    cd src/github.com/gogits/gogs
    sudo GOPATH=/opt/gogs_build: go build
    cd $base_directory

    # Configure init script
    sudo cp -r ../sources/systemd/. /etc/systemd/system/
    sudo systemctl daemon-reload
    sudo systemctl enable gogs.service
    sudo systemctl enable gogs-web.service

    # Install some files from debian package
    sudo cp ../sources/gogs_default /etc/default/gogs
    sudo cp ../sources/gogs /usr/bin/gogs 
    sudo cp ../sources/other /etc/gogs/conf.d/other
    sudo chmod +x /usr/bin/gogs
    sudo cp -r ../sources/vendor /opt/gogs/
    sudo chown gogs:gogs -R /etc/gogs
    sudo chmod 740 -R /etc/gogs
fi


# Copy and edit app.ini
sudo cp ../conf/app.ini /opt/gogs/custom/conf
sudo sed -i "s@yuno_repo@$repo_path@g" /opt/gogs/custom/conf/app.ini
sudo sed -i "s@yuno_url@$domain$path@g" /opt/gogs/custom/conf/app.ini
sudo sed -i "s/yuno_dbpdw/$db_pwd/g" /opt/gogs/custom/conf/app.ini
sudo sed -i "s/yuno_dbuser/$app/g" /opt/gogs/custom/conf/app.ini
sudo sed -i "s/yuno_domain/$domain/g" /opt/gogs/custom/conf/app.ini
sudo sed -i "s/yuno_key/$key/g" /opt/gogs/custom/conf/app.ini
sudo chown gogs:gogs /opt/gogs/custom/conf/app.ini

# Modify Nginx configuration file and copy it to Nginx conf directory
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf*
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/$app.conf

# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app ssowatconf

sudo service gogs-web restart